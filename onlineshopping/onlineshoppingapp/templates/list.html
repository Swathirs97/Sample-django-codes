{% extends 'home.html' %}

{% block content %}

<style>
  /* General Styles */
  body {
    background: #fafafa;
    font-family: 'Cormorant Garamond', 'Playfair Display', Georgia, serif;
    color: #2c2c2c;
    font-size: 16px;
    letter-spacing: 0.3px;
  }

  /* Page Title Styles */
  .page-title {
    text-align: center;
    margin-bottom: 40px;
    font-size: 3rem;
    font-weight: 300;
    color: #2c2c2c;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .page-title i {
    color: #d4af37;
    margin-right: 15px;
    font-size: 2.5rem;
  }

  /* Product Count Styles */
  .product-count {
    color: #8b8b8b;
    font-size: 1rem;
    font-weight: 300;
    margin-top: 15px;
    letter-spacing: 1px;
    font-family: 'Lato', sans-serif;
  }

  .product-count span {
    color: #d4af37;
    font-weight: 400;
  }

  /* Category Filter Badge Styles */
  .category-filter-badge {
    background: #1a1a1a;
    padding: 12px 30px;
    border-radius: 0;
    color: #d4af37;
    font-weight: 300;
    font-size: 1rem;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    display: inline-block;
    border: 1px solid #d4af37;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Clear Filter Button Styles */
  .clear-filter-btn {
    display: inline-block;
    margin-left: 20px;
    background: transparent;
    padding: 12px 30px;
    border-radius: 0;
    color: #d4af37;
    font-weight: 300;
    text-decoration: none;
    transition: all 0.4s ease;
    border: 2px solid #d4af37;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .clear-filter-btn:hover {
    background: #d4af37;
    color: #1a1a1a;
  }

  /* Info Banner Styles */
  .info-banner {
    background: #1a1a1a;
    padding: 20px 40px;
    border-radius: 0;
    margin-bottom: 40px;
    text-align: center;
    border-top: 1px solid #d4af37;
    border-bottom: 1px solid #d4af37;
    box-shadow: none;
  }

  .info-banner p {
    margin: 0;
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .info-banner a {
    color: #fff;
    text-decoration: none;
    font-weight: 700;
    border-bottom: 2px solid #fff;
    padding-bottom: 2px;
    transition: all 0.2s ease;
  }

  .info-banner a:hover {
    opacity: 0.8;
  }

  /* Search Container Styles */
  .search-container {
    background: #ffffff;
    padding: 40px;
    border-radius: 0;
    box-shadow: 0 2px 20px rgba(0,0,0,0.06);
    margin-bottom: 50px;
    border: 1px solid #e8e8e8;
  }

  /* Search Form Styles */
  .search-form {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* Search Input Wrapper Styles */
  .search-input-wrapper {
    position: relative;
    flex: 1;
    min-width: 300px;
    max-width: 500px;
  }

  .search-input-wrapper i {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #718096;
    font-size: 1.1rem;
  }

  /* Search Input Styles */
  .search-input {
    width: 100%;
    border: none;
    border-bottom: 2px solid #e8e8e8;
    border-radius: 0;
    padding: 14px 20px 14px 50px;
    font-size: 1rem;
    transition: all 0.4s ease;
    background: transparent;
    font-weight: 300;
    color: #2c2c2c;
    font-family: 'Lato', sans-serif;
  }

  .search-input:hover {
    border-bottom-color: #d4af37;
    background: transparent;
  }

  .search-input:focus {
    border-bottom-color: #d4af37;
    box-shadow: none;
    outline: none;
    background: transparent;
  }

  .search-input::placeholder {
    color: #8b8b8b;
    font-weight: 300;
    letter-spacing: 0.5px;
  }

  /* Search Button Styles */
  .search-btn {
    background: transparent;
    color: #d4af37;
    border: 2px solid #d4af37;
    border-radius: 0;
    padding: 14px 40px;
    font-weight: 300;
    font-size: 0.9rem;
    transition: all 0.4s ease;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .search-btn:hover {
    background: #d4af37;
    color: #1a1a1a;
    transform: none;
  }

  /* Search Results Styles */
  #searchResults {
    margin-top: 15px;
    color: #2d3748;
    font-weight: 600;
    text-align: center;
    font-size: 1.1rem;
  }

  /* Product Card Styles */
  .product-card {
    background: #ffffff;
    border: 1px solid #e8e8e8;
    border-radius: 0;
    transition: all 0.5s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 20px rgba(0,0,0,0.06);
  }

  .product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 8px 40px rgba(212,175,55,0.15);
    border-color: #d4af37;
  }

  /* Product Image Container Styles */
  .product-image-container {
    position: relative;
    overflow: hidden;
    height: 280px;
    background: #f7fafc;
    border-radius: 8px 8px 0 0;
  }

  .product-card img {
    height: 100%;
    width: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .product-card:hover img {
    transform: scale(1.05);
  }

  /* Category Badge Styles */
  .category-badge {
    display: inline-block;
    background: transparent;
    color: #8b8b8b;
    padding: 6px 16px;
    border-radius: 0;
    font-size: 0.75rem;
    font-weight: 300;
    margin-bottom: 12px;
    border: 1px solid #e8e8e8;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-family: 'Lato', sans-serif;
  }

  /* Card Title Styles */
  .card-title {
    font-weight: 400;
    color: #2c2c2c;
    margin-bottom: 15px;
    font-size: 1.4rem;
    line-height: 1.5;
    letter-spacing: 0.5px;
    font-family: 'Lato', sans-serif;
  }

  /* Rating Badge Styles */
  .rating-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #2c2c2c;
    padding: 8px 0;
    border-radius: 0;
    font-weight: 300;
    margin-top: 10px;
    font-size: 0.9rem;
  }

  .rating-badge i {
    color: #d4af37;
    font-size: 0.9rem;
  }

  .rating-count {
    color: #8b8b8b;
    font-weight: 300;
    font-size: 0.85rem;
    margin-left: 4px;
    font-family: 'Lato', sans-serif;
  }

  /* Card Body Styles */
  .card-body {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .card-body h6 {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1a202c;
    margin-top: auto;
    margin-bottom: 15px;
    font-family: 'Lato', sans-serif;
  }

  /* Product Actions Styles */
  .product-actions {
    display: flex;
    gap: 8px;
    margin-top: auto;
    align-items: center;
    justify-content: flex-start;
    flex-wrap: nowrap;
  }

  /* Theme variables for consistent button styling */
  :root{
    --site-bg: #fafafa;
    --card-bg: #ffffff;
    --text-primary: #2c2c2c;
    --muted: #8b8b8b;
    --primary: #d4af37; /* elegant gold */
    --accent: #d4af37;  /* gold accent */
    --dark: #1a1a1a; /* dark charcoal */
    --btn-radius: 0;
  }

  /* Button View Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 18px;
    border-radius: 0;
    font-weight: 300;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.4s ease;
    text-decoration: none;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    font-family: 'Lato', sans-serif;
  }

  .btn:active{ transform: translateY(0); }

  .btn-primary{
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
    min-width: 120px;
    text-decoration: none;
  }

  .btn-outline{
    background: transparent;
    color: var(--dark);
    border: 2px solid var(--dark);
    text-decoration: none;
  }

  .btn-primary:hover{ background: var(--primary); color: var(--dark); text-decoration: none; }
  .btn-outline:hover{ background: var(--dark); color: #fff; text-decoration: none; }

  /* Button Edit Styles */
  .btn-edit { background: transparent; color: var(--dark); border: 1px solid var(--dark); padding:11px 16px; text-decoration: none; transition: all 0.3s ease; font-size: 0.8rem; }

  .btn-edit:hover {
    background: var(--dark);
    color: #fff;
    text-decoration: none;
  }

  .btn-edit i {
    font-size: 0.95rem;
  }

  /* Button Delete Styles */
  .btn-danger{ background: transparent; color: var(--muted); border: 1px solid var(--muted); padding:11px 16px; text-decoration: none; transition: all 0.3s ease; font-size: 0.8rem; }

  /* Buy Now / primary action */
  .btn-buy{ background: transparent; color: var(--primary); border: 1px solid var(--primary); font-weight:400; min-width:110px; padding:11px 18px; letter-spacing:1.2px; text-decoration: none; font-size: 0.8rem; }
  .btn-buy:hover{ background: var(--primary); color: var(--dark); text-decoration: none; }

  .btn-add-to-cart{ background: var(--dark); color:#fff; padding:11px 18px; border: 1px solid var(--dark); text-decoration: none; font-size: 0.8rem; }
  .btn-go-to-cart{ background: var(--dark); color:#fff; padding:11px 18px; border: 1px solid var(--dark); text-decoration: none; font-size: 0.8rem; }

  .btn-wishlist{ background: transparent; border:1px solid var(--muted); color: var(--muted); padding:10px 16px; text-decoration: none; }

  .btn-checkout{ background: var(--primary); color: var(--dark); padding:16px 24px; font-weight:400; width:100%; border:none; letter-spacing:2px; text-transform:uppercase; }
  .btn-checkout:hover{ background: var(--dark); color: var(--primary); }

  .btn-delete:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-2px);
    text-decoration: none;
  }

  /* Wishlist Active Button Styles */
  .btn-wishlist-active {
    background: transparent !important;
    border-color: var(--primary) !important;
    color: var(--primary) !important;
    text-decoration: none !important;
  }

  .btn-wishlist-active i {
    color: var(--primary);
  }

  /* Add to Cart Button Styles */
  .btn-add-to-cart {
    background: var(--dark) !important;
    border: 1px solid var(--dark) !important;
    color: #fff !important;
    font-weight: 300;
    padding: 11px 18px !important;
    font-size: 0.8rem !important;
  }

  .btn-add-to-cart:hover {
    background: transparent !important;
    color: var(--dark) !important;
  }

  /* Go to Cart Button Styles */
  .btn-go-to-cart {
    background: var(--dark) !important;
    border: 1px solid var(--dark) !important;
    color: #fff !important;
    font-weight: 300;
    padding: 11px 18px !important;
    font-size: 0.8rem !important;
  }

  .btn-go-to-cart:hover {
    background: transparent !important;
    color: var(--dark) !important;
  }

  /* Modal Styles */
  .modal-content {
    border-radius: 0;
    border: 1px solid #e8e8e8;
    box-shadow: 0 10px 60px rgba(0,0,0,0.15);
  }

  .modal-header {
    background: #fafafa;
    color: #2c2c2c;
    border-radius: 0;
    padding: 30px;
    border-bottom: 1px solid #e8e8e8;
  }

  .modal-title {
    font-weight: 700;
    font-size: 1.5rem;
    color: #fff;
  }

  .modal-body {
    padding: 30px;
    color: #000000;
  }

  .modal-body img {
    border-radius: 8px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 2px solid #e5e5e5;
  }

  .modal-body p {
    color: #2c2c2c;
    font-size: 1rem;
    font-weight: 300;
    line-height: 1.8;
    font-family: 'Lato', sans-serif;
  }

  .modal-body strong {
    color: #2c2c2c;
    font-weight: 400;
  }

  /* Star Rating Styles */
  .star-rating {
    display: inline-flex;
    gap: 8px;
    font-size: 1.5rem;
    cursor: pointer;
  }

  .star-rating i {
    color: #e8e8e8;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .star-rating i:hover,
  .star-rating i.hover {
    color: #d4af37;
    transform: scale(1.1);
  }

  .star-rating i.fas {
    color: #d4af37;
  }

  /* No Products Styles */
  .no-products {
    background: #ffffff;
    padding: 80px 60px;
    border-radius: 0;
    text-align: center;
    box-shadow: 0 2px 20px rgba(0,0,0,0.06);
    border: 1px solid #e8e8e8;
  }

  .no-products i {
    font-size: 4rem;
    color: #d4af37;
    margin-bottom: 30px;
    opacity: 0.6;
  }

  .no-products h3 {
    color: #2c2c2c;
    font-weight: 300;
    margin-bottom: 15px;
    font-size: 2rem;
    letter-spacing: 2px;
  }

  .no-products p {
    color: #8b8b8b;
    font-size: 1rem;
    margin-bottom: 30px;
    font-weight: 300;
    font-family: 'Lato', sans-serif;
  }

  /* Media Queries */
  @media (max-width: 768px) {
    .page-title {
      font-size: 1.8rem;
    }

    .search-input-wrapper {
      min-width: 100%;
    }
  }
</style>

<div class="container">
  <div class="text-center">
    <h1 class="page-title">
      <i class="fas fa-store"></i>
      {% if category %}{{ category.name }}{% else %}Product Catalog{% endif %}
    </h1>
    <p class="product-count">
      <i class="fas fa-box"></i> Total Products: <span>{{ total_products }}</span>
    </p>
    {% if category %}
    <div style="margin-top: 20px;">
      <span class="category-filter-badge">
        <i class="fas fa-filter"></i> Filtered by: {{ category.name }}
      </span>
      <a href="{% url 'list' %}" class="clear-filter-btn">
        <i class="fas fa-times-circle"></i> Clear Filter
      </a>
    </div>
    {% endif %}
  </div>

  {% if not user.is_authenticated %}
  <div class="info-banner">
    <p>
      <i class="fas fa-info-circle"></i>
      <a href="{% url 'signin' %}">Sign in</a> to add products to wishlist and cart ðŸ›’
    </p>
  </div>
  {% elif user.is_authenticated and not user.is_staff and not user.is_superuser %}
  <div class="info-banner" style="background: linear-gradient(135deg, var(--accent) 0%, #131313 100%);">
    <p>
      <i class="fas fa-shopping-bag"></i>
      Browse products and add them to your
      <a href="{% url 'wishlist' %}">Wishlist</a> or <a href="{% url 'cart' %}">Cart</a> ðŸ›’
    </p>
  </div>
  {% endif %}

  <div class="search-container">
    <form class="search-form" action="search" method="post" id="searchForm">
      {% csrf_token %}
      <div class="search-input-wrapper">
        <i class="fas fa-search"></i>
        <input class="search-input" type="search" placeholder="Search by Product Name..." aria-label="Search" id="n1" name="n1" autocomplete="off">
      </div>
      <button class="search-btn" type="submit">
        <i class="fas fa-search"></i> Search
      </button>
    </form>
    <div id="searchResults"></div>
  </div>

  <div class="row" id="productContainer">
    {% if products %}
    {% for product in products %}
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card product-card">
        <div class="product-image-container" data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}" style="cursor:pointer;">
              <img src="{{ product.image.url }}" alt="{{ product.name }}">
            </div>
        <div class="card-body">
          <span class="category-badge">
            <i class="fas fa-folder"></i> {{ product.category.name }}
          </span>
          <h5 class="card-title" data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}" style="cursor:pointer;">{{ product.name }}</h5>
          
          <div class="rating-badge" title="Average rating">
            {% with avg_rating=product.average_rating %}
            {% if avg_rating >= 1 %}<i class="fas fa-star"></i>{% else %}<i class="far fa-star"></i>{% endif %}
            {% if avg_rating >= 2 %}<i class="fas fa-star"></i>{% else %}{% if avg_rating >= 1.5 %}<i class="fas fa-star-half-alt"></i>{% else %}<i class="far fa-star"></i>{% endif %}{% endif %}
            {% if avg_rating >= 3 %}<i class="fas fa-star"></i>{% else %}{% if avg_rating >= 2.5 %}<i class="fas fa-star-half-alt"></i>{% else %}<i class="far fa-star"></i>{% endif %}{% endif %}
            {% if avg_rating >= 4 %}<i class="fas fa-star"></i>{% else %}{% if avg_rating >= 3.5 %}<i class="fas fa-star-half-alt"></i>{% else %}<i class="far fa-star"></i>{% endif %}{% endif %}
            {% if avg_rating >= 5 %}<i class="fas fa-star"></i>{% else %}{% if avg_rating >= 4.5 %}<i class="fas fa-star-half-alt"></i>{% else %}<i class="far fa-star"></i>{% endif %}{% endif %}
            {% endwith %}
            <span style="margin-left: 5px; font-weight: 700; color: #1a202c;">{{ product.average_rating }}</span>
            <span class="rating-count">({{ product.review_count }})</span>
          </div>

          <h6><i class="fas fa-tag"></i> â‚¹{{ product.price }}</h6>

          <div class="product-actions">
            {% if user.is_authenticated %}
              {% if user.is_staff or user.is_superuser %}
                <a href="edit/{{product.id}}" class="btn-edit" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="delete/{{product.id}}" class="btn-delete">
                  <i class="fas fa-trash"></i> Delete
                </a>
              {% else %}
                {% if product.id in wishlist_products %}
                <a href="{% url 'add_to_wishlist' product.id %}" class="btn-edit btn-wishlist-active" title="Remove from wishlist">
                  <i class="fas fa-heart"></i>
                </a>
                {% else %}
                <a href="{% url 'add_to_wishlist' product.id %}" class="btn-edit" title="Add to wishlist">
                  <i class="far fa-heart"></i>
                </a>
                {% endif %}

                {% if product.id in cart_products %}
                <a href="{% url 'cart' %}" class="btn-delete btn-go-to-cart" title="View cart">
                  <i class="fas fa-shopping-bag"></i> GO TO CART
                </a>
                {% else %}
                <a href="{% url 'add_to_cart' product.id %}" class="btn-delete btn-add-to-cart" title="Add to cart">
                  <i class="fas fa-shopping-cart"></i> ADD TO CART
                </a>
                {% endif %}

                <!-- BUY NOW always visible regardless of cart status -->
                <form method="post" action="{% url 'buy_now' product.id %}" style="display:inline-block; margin-left:8px;">
                  {% csrf_token %}
                  <input type="hidden" name="quantity" value="1">
                  <button type="submit" class="btn btn-buy" title="Buy now">
                    <i class="fas fa-bolt"></i> BUY NOW
                  </button>
                </form>
              {% endif %}
            {% else %}
              <a href="{% url 'signin' %}" class="btn-edit" title="Sign in to wishlist"><i class="far fa-heart"></i></a>
              <a href="{% url 'signin' %}" class="btn-delete btn-add-to-cart"><i class="fas fa-shopping-cart"></i> ADD TO CART</a>
              <a href="{% url 'signin' %}" class="btn btn-buy"><i class="fas fa-bolt"></i> BUY NOW</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="productModal{{ product.id }}" tabindex="-1" aria-labelledby="productModalLabel{{ product.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productModalLabel{{ product.id }}">
              <i class="fas fa-box"></i> {{ product.name }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <img src="{{ product.image.url }}" class="img-fluid w-100" alt="{{ product.name }}" style="height: 400px; object-fit: cover;">
            <div class="mt-4">
              <p><i class="fas fa-folder" style="color: #2d3748;"></i> <strong>Category:</strong> {{ product.category.name }}</p>
              <p><i class="fas fa-align-left" style="color: #2d3748;"></i> <strong>Description:</strong> {{ product.description }}</p>
              <p style="font-size: 1.3rem;"><strong>Price:</strong> <span style="color: #1a202c; font-weight: 700;">â‚¹{{ product.price }}</span></p>

              <div style="margin-top: 18px;">
                <h6 style="margin-bottom: 12px; font-weight: 700; color: #1a202c; font-size: 1.1rem;">Recent Reviews</h6>
                <div style="max-height: 400px; overflow-y: auto;">
                  {% for r in product.reviews.all|slice:":3" %}
                  <div style="padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                    <div style="margin-bottom: 6px;">
                      <strong style="color: #1a202c; font-size: 1rem;">{{ r.user.username }}</strong>
                      <span style="color: var(--accent); margin-left: 10px;">
                        {% for i in "12345" %}
                          {% if forloop.counter <= r.rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </span>
                    </div>
                    <div style="color: #2d3748; font-weight: 500; line-height: 1.5;">{{ r.comment|default:'-' }}</div>
                    <small style="color: #718096; font-weight: 500;">{{ r.created_at|date:'d M Y H:i' }}</small>
                    {% if r.admin_reply %}
                    <div style="margin-top: 10px; padding: 10px; background: #edf2f7; border-left: 3px solid #2d3748; border-radius: 4px;">
                      <div style="margin-bottom: 4px;">
                        <i class="fas fa-reply" style="color: #2d3748;"></i>
                        <strong style="color: #2d3748; font-size: 0.95rem; margin-left: 5px;">Admin Reply:</strong>
                      </div>
                      <div style="color: #1a202c; font-weight: 500; line-height: 1.5; font-size: 0.95rem;">{{ r.admin_reply }}</div>
                    </div>
                    {% endif %}
                  </div>
                  {% empty %}
                  <div style="color: #718096; font-weight: 500;">No reviews yet.</div>
                  {% endfor %}
                </div>
              </div>

              {% if user.is_authenticated %}
              <form method="post" action="{% url 'submit_review' product.id %}" style="margin-top: 20px;" id="reviewForm{{ product.id }}">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                  <label style="font-weight: 700; color: #1a202c; display: block; margin-bottom: 10px; font-size: 1rem;">Your Rating:</label>
                  <div class="star-rating" data-product-id="{{ product.id }}">
                    <i class="far fa-star" data-rating="1"></i>
                    <i class="far fa-star" data-rating="2"></i>
                    <i class="far fa-star" data-rating="3"></i>
                    <i class="far fa-star" data-rating="4"></i>
                    <i class="far fa-star" data-rating="5"></i>
                  </div>
                  <input type="hidden" name="rating" id="ratingInput{{ product.id }}" value="0" required>
                  <small class="rating-message" style="color: var(--accent); display: none; font-weight: 600;">Please select a rating</small>
                </div>
                <div style="margin-top: 10px;">
                  <textarea name="comment" rows="3" placeholder="Write your review..." style="width: 100%; padding: 12px; border-radius: 6px; border: 2px solid #cbd5e0; font-size: 1rem; font-weight: 500; color: #1a202c;"></textarea>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                  <button class="btn btn-view" type="submit" style="font-size: 1rem;">Submit Review</button>
                </div>
              </form>
              {% else %}
              <div style="margin-top: 15px; color: #718096; font-weight: 600;">Please <a href="{% url 'signin' %}" style="color: #2d3748; font-weight: 700;">sign in</a> to submit a review.</div>
              {% endif %}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 6px; font-weight: 700; background: #718096; border: none; color: #fff;">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12">
      <div class="no-products">
        <i class="fas fa-box-open"></i>
        <h3>No Products Found</h3>
        <p>
          {% if category %}
          There are no products available in the "{{ category.name }}" category at the moment.
          {% else %}
          There are no products available at the moment.
          {% endif %}
        </p>
        <a href="{% url 'home' %}" class="btn btn-view" style="display: inline-block; font-size: 1rem;">
          <i class="fas fa-arrow-left"></i> Back to Home
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  // Live search functionality
  const searchInput = document.getElementById('n1');
  const searchForm = document.getElementById('searchForm');
  const productContainer = document.getElementById('productContainer');
  const searchResults = document.getElementById('searchResults');
  let searchTimeout;

  // Function to perform product search
  function performSearch(searchQuery) {
    const formData = new FormData(searchForm);

    fetch('/search', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newProducts = doc.getElementById('productContainer');

      if (newProducts) {
        productContainer.innerHTML = newProducts.innerHTML;
        // Count only div elements with product-card class
        const productCount = newProducts.querySelectorAll('.product-card').length;

        if (searchQuery.trim() === '') {
          searchResults.textContent = '';
        } else {
          searchResults.textContent = `Found ${productCount} product${productCount !== 1 ? 's' : ''} matching "${searchQuery}"`;
        }

        initializeStarRatings();
      }
    })
    .catch(error => {
      console.error('Search error:', error);
      searchResults.textContent = 'Error performing search. Please try again.';
      searchResults.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#4f46e5';
    });
  }

  // Event listener for search input
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const searchQuery = this.value;
    
    if (searchQuery.trim() !== '') {
      searchResults.textContent = 'Searching...';
      searchResults.style.color = '#2d3748';
    }
    
    searchTimeout = setTimeout(() => {
      performSearch(searchQuery);
    }, 300);
  });

  // Event listener for search form submission
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    clearTimeout(searchTimeout);
    performSearch(searchInput.value);
  });

  // Star Rating System
  function initializeStarRatings() {
    const starContainers = document.querySelectorAll('.star-rating');
    
    starContainers.forEach(container => {
      const stars = container.querySelectorAll('i');
      const productId = container.dataset.productId;
      const ratingInput = document.getElementById(`ratingInput${productId}`);
      const form = document.getElementById(`reviewForm${productId}`);
      const ratingMessage = form ? form.querySelector('.rating-message') : null;

      // Event listener for each star
      stars.forEach((star, index) => {
        // Click event to select rating
        star.addEventListener('click', function() {
          const rating = this.dataset.rating;
          const currentRating = ratingInput.value;
          
          // Toggle rating if clicking the same star
          if (currentRating === rating) {
            ratingInput.value = '0';
            stars.forEach(s => {
              s.classList.remove('fas');
              s.classList.add('far');
            });
          } else {
            ratingInput.value = rating;
            stars.forEach((s, i) => {
              if (i < rating) {
                s.classList.remove('far');
                s.classList.add('fas');
              } else {
                s.classList.remove('fas');
                s.classList.add('far');
              }
            });
          }
          
          // Hide rating message if visible
          if (ratingMessage) {
            ratingMessage.style.display = 'none';
          }
        });

        // Mouse enter event for hover effect
        star.addEventListener('mouseenter', function() {
          const rating = this.dataset.rating;
          stars.forEach((s, i) => {
            if (i < rating) {
              s.classList.add('hover');
            }
          });
        });

        // Mouse leave event to remove hover effect
        star.addEventListener('mouseleave', function() {
          stars.forEach(s => {
            s.classList.remove('hover');
          });
        });
      });

      // Form submission validation
      if (form) {
        form.addEventListener('submit', function(e) {
          if (!ratingInput.value || ratingInput.value === '0') {
            e.preventDefault();
            
            // Show rating message
            if (ratingMessage) {
              ratingMessage.style.display = 'block';
            }
            
            // Highlight stars with the accent color
            const _accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#4f46e5';
            stars.forEach(star => {
              star.style.color = _accent;
            });
            
            // Reset star color after 1 second
            setTimeout(() => {
              stars.forEach(star => {
                star.style.color = '';
              });
            }, 1000);
          }
        });
      }
    });
  }

  // Initialize star ratings on page load
  initializeStarRatings();

  // Mutation observer to reinitialize ratings when products are dynamically added
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length) {
        initializeStarRatings();
      }
    });
  });
  
  observer.observe(productContainer, {
    childList: true,
    subtree: true
  });
</script>
{% endblock %}
